<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Stories</title>
    <!-- Carrega o Tailwind CSS para estilização rápida -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo customizado para a barra de progresso */
        .progress-fill {
            transition: width 0.1s linear;
        }

        /* Estilo para o botão de curtir */
        #like-button-svg {
            transition: all 0.2s ease-in-out;
        }
        #like-button-svg.liked {
            fill: #FF0000;
            stroke: #FF0000;
        }

        /* Garante que o toque/arraste seja suave */
        body {
            overscroll-behavior: none;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen font-sans">

    <!-- Container principal que simula a tela de um celular -->
    <main id="story-container" class="relative w-full max-w-md aspect-[9/16] bg-black rounded-xl shadow-2xl overflow-hidden select-none">
        
        <!-- Este wrapper agrupa TODO o conteúdo do story para que possa ser movido de uma vez -->
        <div id="story-content-wrapper" class="relative w-full h-full">

            <!-- 1. Barras de Progresso (Topo) -->
            <header class="absolute top-2 left-2 right-2 z-30">
                <div id="progress-bars" class="flex gap-1 w-full">
                    <!-- As barras de progresso serão injetadas aqui pelo JavaScript -->
                </div>
            </header>

            <!-- 2. Informação do Usuário (Abaixo das barras) -->
            <div id="story-header" class="absolute top-5 left-4 right-4 z-20 flex items-center gap-3 pt-2">
                <img id="profile-pic" src="" alt="Avatar" class="w-10 h-10 rounded-full border-2 border-white">
                <span id="username" class="text-white font-bold text-sm"></span>
            </div>

            <!-- 3. Imagem Principal do Story -->
            <img id="story-image" 
                 src="" 
                 alt="Story" 
                 class="absolute inset-0 w-full h-full object-cover z-10 transition-opacity duration-300 ease-in-out">
            
            <!-- 5. Gradiente de Sobreposição (Baixo) -->
            <div class="absolute bottom-0 left-0 right-0 h-32 bg-gradient-to-t from-black/50 to-transparent z-10 pointer-events-none"></div>

            <!-- 6. Barra de Interação (Baixo) -->
            <footer class="absolute bottom-0 left-0 right-0 z-20 p-4 flex items-center gap-3">
                
                <div id="comment-bar" class="flex-1 border border-white/40 rounded-full px-4 py-2 cursor-pointer backdrop-blur-sm bg-white/10 hover:bg-white/20 transition-colors">
                    <span class="text-white/80 text-sm">Responder...</span>
                </div>
                
                <button id="like-button" class="p-2 rounded-full active:bg-white/20">
                    <svg id="like-button-svg" xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                </button>
                
                <button id="send-button" class="p-2 rounded-full active:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </footer>
        
        </div> <!-- Fim do #story-content-wrapper -->
        
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DADOS DOS STORIES (LISTA DE USUÁRIOS) ---
            const allUsersData = [
                {
                    user: 'seu_usuario',
                    avatar: 'https://placehold.co/40x40/FFFFFF/000000?text=SU',
                    items: [
                        { src: 'https://placehold.co/360x640/FF6347/FFFFFF?text=Foto+1', duration: 5000 },
                        { src: 'https://placehold.co/360x640/4682B4/FFFFFF?text=Foto+2', duration: 5000 },
                    ]
                },
                {
                    user: 'amigo_legal',
                    avatar: 'https://placehold.co/40x40/0000FF/FFFFFF?text=AL',
                    items: [
                        { src: 'https://placehold.co/360x640/32CD32/FFFFFF?text=Story+Verde', duration: 3000 },
                    ]
                },
                {
                    user: 'outro_perfil',
                    avatar: 'https://placehold.co/40x40/FF00FF/FFFFFF?text=OP',
                    items: [
                        { src: 'https://placehold.co/360x640/FFD700/FFFFFF?text=Story+Amarelo', duration: 5000 },
                        { src: 'https://placehold.co/360x640/8A2BE2/FFFFFF?text=Story+Roxo', duration: 4000 },
                        { src: 'https://placehold.co/360x640/A52A2A/FFFFFF?text=Story+Marrom', duration: 5000 },
                    ]
                }
            ];

            // --- VARIÁVEIS DE ESTADO ---
            let currentUserIndex = 0;
            let currentStoryIndex = 0;
            let storyTimer;
            let isPaused = false;
            let pressStartTime = 0;
            let allProgressFills = [];
            
            // Novas variáveis para o arraste (swipe)
            let isDragging = false;
            let dragStartX = 0;
            let dragDeltaX = 0;

            // --- ELEMENTOS DO DOM ---
            const storyContainer = document.getElementById('story-container');
            const storyContentWrapper = document.getElementById('story-content-wrapper'); // O novo wrapper
            const progressBarsContainer = document.getElementById('progress-bars');
            const storyImage = document.getElementById('story-image');
            const profilePic = document.getElementById('profile-pic');
            const username = document.getElementById('username');
            const commentBar = document.getElementById('comment-bar');
            const likeButton = document.getElementById('like-button');
            const sendButton = document.getElementById('send-button');
            const likeIcon = document.getElementById('like-button-svg');

            // --- FUNÇÕES DE AJUDA ---

            function stopPropagation(e) {
                e.stopPropagation();
            }

            function toggleLike(e) {
                stopPropagation(e);
                likeIcon.classList.toggle('liked');
            }

            // --- FUNÇÕES PRINCIPAIS DE NAVEGAÇÃO ---

            function loadUserStories(userIndex, storyIndex = 0) {
                // Validação de limites
                if (userIndex < 0) {
                    userIndex = 0;
                }
                if (userIndex >= allUsersData.length) {
                    userIndex = 0; // Volta para o primeiro usuário (loop)
                }

                currentUserIndex = userIndex;
                const userData = allUsersData[currentUserIndex];

                // 1. Atualiza informações do usuário
                profilePic.src = userData.avatar;
                username.textContent = userData.user;
                commentBar.querySelector('span').textContent = `Responder a ${userData.user}...`;

                // 2. Reconstrói as barras de progresso
                progressBarsContainer.innerHTML = '';
                userData.items.forEach(() => {
                    const barContainer = document.createElement('div');
                    barContainer.className = 'flex-1 h-1 bg-white/30 rounded-full overflow-hidden';
                    const fill = document.createElement('div');
                    fill.className = 'progress-fill h-full bg-white w-0';
                    barContainer.appendChild(fill);
                    progressBarsContainer.appendChild(barContainer);
                });
                
                allProgressFills = document.querySelectorAll('.progress-fill');

                // 3. Mostra o story de início
                showStory(storyIndex);
            }

            function showStory(storyIndex) {
                currentStoryIndex = storyIndex;
                isPaused = false;
                clearTimeout(storyTimer);
                likeIcon.classList.remove('liked');

                // MUDANÇA: Reseta a posição E opacidade do wrapper
                storyContentWrapper.style.transition = 'none'; // Sem animação
                storyContentWrapper.style.transform = 'translateX(0px)'; // Posição inicial
                storyContentWrapper.style.opacity = '1'; // Garante opacidade total

                const userData = allUsersData[currentUserIndex];
                
                if (!userData || !userData.items[currentStoryIndex]) {
                    console.error("Story não encontrado.");
                    nextUser();
                    return;
                }
                
                const item = userData.items[currentStoryIndex];

                // 1. Atualiza a imagem
                storyImage.style.opacity = '0.5';
                const img = new Image();
                img.onload = () => {
                    storyImage.src = item.src;
                    storyImage.style.opacity = '1';

                    // 2. Atualiza as barras de progresso
                    updateProgressBars();

                    // 3. Inicia a animação da barra atual
                    startProgressBarAnimation(item.duration);

                    // 4. Configura o timer para o próximo story
                    storyTimer = setTimeout(nextStory, item.duration);
                };
                img.src = item.src;
            }

            function updateProgressBars() {
                allProgressFills.forEach((fill, i) => {
                    fill.style.transition = 'none';
                    if (i < currentStoryIndex) {
                        fill.style.width = '100%';
                    } else {
                        fill.style.width = '0%';
                    }
                });
            }

            function startProgressBarAnimation(duration) {
                const currentFill = allProgressFills[currentStoryIndex];
                if (!currentFill) return;

                void currentFill.offsetWidth; // Força reflow

                currentFill.style.transition = `width ${duration}ms linear`;
                currentFill.style.width = '100%';
            }
            
            function pauseStory() {
                if (isPaused) return;
                isPaused = true;
                clearTimeout(storyTimer);

                const currentFill = allProgressFills[currentStoryIndex];
                if (!currentFill) return;

                const computedWidth = getComputedStyle(currentFill).width;
                currentFill.style.transition = 'none';
                currentFill.style.width = computedWidth;
            }

            function resumeStory() {
                if (!isPaused) return;
                isPaused = false;

                const currentFill = allProgressFills[currentStoryIndex];
                if (!currentFill) return;

                const currentWidthPercent = parseFloat(currentFill.style.width) || 0;
                const fullDuration = allUsersData[currentUserIndex].items[currentStoryIndex].duration;
                
                const remainingDuration = fullDuration * (1 - (currentWidthPercent / 100));

                currentFill.style.transition = `width ${remainingDuration}ms linear`;
                currentFill.style.width = '100%';

                storyTimer = setTimeout(nextStory, remainingDuration);
            }

            // --- Funções de Navegação (Nível Story e Usuário) ---

            function nextStory() {
                const currentUserData = allUsersData[currentUserIndex];
                
                if (currentStoryIndex + 1 < currentUserData.items.length) {
                    showStory(currentStoryIndex + 1);
                } else {
                    nextUser();
                }
            }

            function prevStory() {
                if (currentStoryIndex - 1 >= 0) {
                    showStory(currentStoryIndex - 1);
                } else {
                    prevUser();
                }
            }
            
            function nextUser() {
                loadUserStories(currentUserIndex + 1, 0);
            }
            
            function prevUser() {
                const prevUserIndex = currentUserIndex - 1;
                
                if (prevUserIndex < 0) {
                    showStory(0); // Apenas reinicia o primeiro story
                    return;
                }
                
                const prevUserData = allUsersData[prevUserIndex];
                const lastStoryIndex = prevUserData.items.length - 1;
                
                loadUserStories(prevUserIndex, lastStoryIndex);
            }

            // --- NOVOS HANDLERS DE EVENTO (Lógica de Toque/Arraste/Segurar) ---

            function onDragStart(e) {
                pauseStory(); // Sempre pausa ao tocar
                
                dragStartX = e.clientX || e.touches[0].clientX;
                pressStartTime = Date.now();
                isDragging = false; // Ainda não sabemos se é um arraste
                dragDeltaX = 0;
                
                storyContentWrapper.style.transition = 'none'; // Tira a animação para seguir o dedo

                // Adiciona os listeners de movimento e soltura NA JANELA
                window.addEventListener('mousemove', onDragMove);
                window.addEventListener('mouseup', onDragEnd);
                
                window.addEventListener('touchmove', onDragMove, { passive: false });
                window.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (dragStartX === 0) return; 
                e.preventDefault();

                isDragging = true;
                const currentX = e.clientX || e.touches[0].clientX;
                dragDeltaX = currentX - dragStartX;

                // Move o wrapper junto com o dedo
                storyContentWrapper.style.transform = `translateX(${dragDeltaX}px)`;
            }

            function onDragEnd(e) {
                // Remove os listeners da janela
                window.removeEventListener('mousemove', onDragMove);
                window.removeEventListener('mouseup', onDragEnd);
                window.removeEventListener('touchmove', onDragMove);
                window.removeEventListener('touchend', onDragEnd);

                if (isPaused) { 
                    const pressDuration = Date.now() - pressStartTime;
                    
                    // MUDANÇA: Limite de arraste reduzido (20% da tela)
                    const dragThreshold = storyContainer.offsetWidth / 5; 

                    // MUDANÇA: Animação de "snap" mais rápida e com opacidade
                    storyContentWrapper.style.transition = 'transform 0.25s ease-out, opacity 0.25s ease-out';

                    // CASO 1: FOI UM ARRASTE (SWIPE)
                    if (isDragging && Math.abs(dragDeltaX) > 20) {
                        
                        if (dragDeltaX > dragThreshold && currentUserIndex > 0) { // Swipe para Direita (Voltar)
                            storyContentWrapper.style.transform = 'translateX(100%)';
                            storyContentWrapper.style.opacity = '0'; // Fade out
                            setTimeout(prevUser, 250); // Timeout igual à animação
                        } 
                        else if (dragDeltaX < -dragThreshold && currentUserIndex < allUsersData.length - 1) { // Swipe para Esquerda (Avançar)
                            storyContentWrapper.style.transform = 'translateX(-100%)';
                            storyContentWrapper.style.opacity = '0'; // Fade out
                            setTimeout(nextUser, 250); // Timeout igual à animação
                        } 
                        else { // Arraste falhou (não foi longe o suficiente)
                            storyContentWrapper.style.transform = 'translateX(0px)';
                            storyContentWrapper.style.opacity = '1'; // Garante que fica visível
                            resumeStory(); // Volta ao normal
                        }

                    } 
                    // CASO 2: FOI UM TOQUE RÁPIDO (SEM ARRASTAR)
                    else if (pressDuration < 200) {
                        storyContentWrapper.style.transform = 'translateX(0px)';
                        storyContentWrapper.style.opacity = '1'; // Garante que fica visível
                        
                        const rect = storyContainer.getBoundingClientRect();
                        const tapPosition = (dragStartX - rect.left) / rect.width;

                        if (tapPosition < 0.33) {
                            prevStory();
                        } else {
                            nextStory();
                        }
                    } 
                    // CASO 3: FOI UM "SEGURAR" (SEM ARRASTAR)
                    else {
                        storyContentWrapper.style.transform = 'translateX(0px)';
                        storyContentWrapper.style.opacity = '1'; // Garante que fica visível
                        resumeStory(); // Apenas retoma o story
                    }
                }
                
                // Reseta as variáveis de arraste
                dragStartX = 0;
                dragDeltaX = 0;
                isDragging = false;
            }
            
            /**
             * Inicializa o visualizador
             */
            function init() {
                // Adiciona listeners para a barra de interação
                likeButton.addEventListener('click', toggleLike);
                commentBar.addEventListener('mousedown', stopPropagation);
                commentBar.addEventListener('touchstart', stopPropagation, { passive: true });
                likeButton.addEventListener('mousedown', stopPropagation);
                likeButton.addEventListener('touchstart', stopPropagation, { passive: true });
                sendButton.addEventListener('mousedown', stopPropagation);
                sendButton.addEventListener('touchstart', stopPropagation, { passive: true });
                sendButton.addEventListener('click', (e) => {
                    stopPropagation(e);
                    console.log('Botão Enviar clicado');
                });

                // Adiciona os event listeners de navegação (agora para o arraste)
                storyContainer.addEventListener('mousedown', onDragStart);
                storyContainer.addEventListener('touchstart', onDragStart, { passive: false });

                // Impede o comportamento nativo de "arrastar imagem" do navegador no desktop
                storyContainer.addEventListener('dragstart', (e) => e.preventDefault());

                // --- INICIA TUDO ---
                loadUserStories(0, 0);
            }

            init();
        });
    </script>

</body>
</html>
